services:
  rabbitmq:
    image: rabbitmq:management-alpine
    env_file: ${PLAYDAY_ENV_FILE:-./.env}
    restart: unless-stopped
    ports:
        - 5672:5672
        - 15672:15672
    volumes:
        - ~/.playday/rabbitmq/data/:/var/lib/rabbitmq/
        - ~/.playday/rabbitmq/log/:/var/log/rabbitmq/
  mongodb:
    build: ./mongodb
    restart: unless-stopped
    ports:
      - 27017:27017
    volumes:
      - ~/.playday/mongodb/data/db:/data/db
    env_file: ${PLAYDAY_ENV_FILE:-./.env}
    command: ["-f", "/etc/mongod.conf"]
  nginx:
    image: nginx:stable-alpine
    build: 
      context: ./nginx
      args:
        PROTOCOL: ${NEXT_PUBLIC_PROTOCOL:-HTTPS}
        EXTERNAL_HTTP_PORT: ${EXTERNAL_HTTP_PORT:-80}
        EXTERNAL_HTTPS_PORT: ${EXTERNAL_HTTPS_PORT:-443}
        WS_LOCAL_PORT: ${WS_LOCAL_PORT:-3005}
        SERVER_NAME: ${NEXT_PUBLIC_WS_BASE_URL:-localhost}
        BASE_URL: ${NEXT_PUBLIC_BASE_URL:-localhost}
    restart: unless-stopped
    ports:
      - ${EXTERNAL_HTTP_PORT:-80}:${EXTERNAL_HTTP_PORT:-80}
      - ${EXTERNAL_HTTPS_PORT:-443}:${EXTERNAL_HTTPS_PORT:-443}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    volumes:
      - ~/.playday/ssldata/certbot/conf:/etc/letsencrypt
      - ~/.playday/ssldata/certbot/www:/var/www/certbot
      - ~/.playday/public/gen:/var/public/gen
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
    image: certbot/certbot
    volumes:
      - ~/.playday/ssldata/certbot/conf:/etc/letsencrypt
      - ~/.playday/ssldata/certbot/www:/var/www/certbot
    restart: unless-stopped
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  taskserver:
    image: ghcr.io/sophluent-systems/playdayai/taskserver:latest
    env_file: ${PLAYDAY_ENV_FILE:-./.env}
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    restart: unless-stopped
    volumes:
      - ~/.playday/public/gen:/public/gen
    deploy:
      resources:
        limits:
          memory: 20G
        reservations:
          memory: 10G       
    extra_hosts:
      - "host.docker.internal:host-gateway"
  watchtower:
    image: containrrr/watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --label-enable --interval 60
  